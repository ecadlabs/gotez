package proto_018_Proxford

import (
	"fmt"
	"testing"

	tz "github.com/ecadlabs/gotez/v2"
	"github.com/ecadlabs/gotez/v2/encoding"
	"github.com/ecadlabs/gotez/v2/protocol/core"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestConstants(t *testing.T) {
	src := []byte{
		0x00, 0x00, 0x01, 0x46, 0x08, 0x20, 0x84, 0x00, 0x00, 0x80, 0x00, 0x14, 0x00, 0x00, 0xc3, 0x50,
		0x00, 0x00, 0xc3, 0x50, 0x00, 0x00, 0x27, 0x10, 0x03, 0x07, 0xd1, 0x02, 0x00, 0x00, 0x75, 0x30,
		0x00, 0x00, 0x10, 0x00, 0xc0, 0x84, 0x3d, 0x03, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x40,
		0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0xfa, 0x7e, 0x80,
		0xb1, 0xbd, 0x02, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0xf8, 0x82, 0xad, 0x16,
		0x80, 0x8c, 0x8d, 0x9e, 0x02, 0x00, 0x00, 0x00, 0x02, 0x54, 0x0b, 0xe4, 0x00, 0x00, 0x00, 0x01,
		0x01, 0xc4, 0xbb, 0xc4, 0x28, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x28,
		0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0xfa, 0x01, 0xa0,
		0xa9, 0x07, 0x00, 0x00, 0x07, 0xd0, 0x00, 0x00, 0x1b, 0x58, 0x00, 0x00, 0x01, 0xf4, 0x3b, 0x9a,
		0xca, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x1b, 0x58, 0x00, 0x00, 0x12, 0x3b, 0x00, 0x02, 0x00, 0x03,
		0x09, 0x05, 0x32, 0xff, 0x00, 0x83, 0xd7, 0x2f, 0x98, 0xdc, 0x41, 0xba, 0xa8, 0xb7, 0x11, 0x36,
		0xf0, 0x5e, 0x2b, 0xc1, 0xdf, 0xd5, 0x24, 0x86, 0x2f, 0x00, 0x05, 0xf5, 0xe1, 0x00, 0x08, 0x08,
		0x00, 0x01, 0x00, 0x00, 0x04, 0x00, 0x32, 0x00, 0x00, 0x00, 0x01, 0x10, 0x10, 0x00, 0x00, 0x10,
		0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x18, 0xaa, 0x00, 0x00, 0x00, 0x28, 0x80, 0xc8, 0xaf,
		0xa0, 0x25, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x75, 0x30, 0x00, 0x00, 0x4e, 0xc0, 0x00, 0x00,
		0x00, 0x64, 0x20, 0x00, 0x00, 0x01, 0xf4, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x20, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0xfe, 0xff,
		0x00, 0x00, 0x00, 0x00, 0x0f, 0xa0, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x08, 0x00, 0x05, 0x02,
		0x05, 0xf5, 0xe1, 0x00, 0x01, 0x90, 0x1f, 0x01, 0x14, 0x00, 0x00, 0x2d, 0x79, 0x88, 0x3d, 0x20,
		0x00, 0x01, 0xa4, 0x01, 0x01, 0x02, 0x01, 0x32, 0x00, 0xff,
	}

	expect := Constants{
		ProofOfWorkNonceSize:                   8,
		NonceLength:                            32,
		MaxAnonOpsPerBlock:                     132,
		MaxOperationDataLength:                 32768,
		MaxProposalsPerDelegate:                20,
		MaxMichelineNodeCount:                  50000,
		MaxMichelineBytesLimit:                 50000,
		MaxAllowedGlobalConstantsDepth:         10000,
		CacheLayoutSize:                        3,
		MichelsonMaximumTypeSize:               2001,
		MaxSlashingPeriod:                      2,
		SmartRollupMaxWrappedProofBinarySize:   30000,
		SmartRollupMessageSizeLimit:            4096,
		SmartRollupMaxNumberOfMessagesPerLevel: tz.BigUint{0xc0, 0x84, 0x3d},
		PreservedCycles:                        3,
		BlocksPerCycle:                         8192,
		BlocksPerCommitment:                    64,
		NonceRevelationThreshold:               512,
		BlocksPerStakeSnapshot:                 512,
		CyclesPerVotingPeriod:                  1,
		HardGasLimitPerOperation:               tz.BigInt{0x80, 0xfa, 0x7e},
		HardGasLimitPerBlock:                   tz.BigInt{0x80, 0xb1, 0xbd, 0x02},
		ProofOfWorkThreshold:                   -1,
		MinimalStake:                           tz.BigUint{0x80, 0xf8, 0x82, 0xad, 0x16},
		MinimalFrozenStake:                     tz.BigUint{0x80, 0x8c, 0x8d, 0x9e, 0x02},
		VDFDifficulty:                          10000000000,
		OriginationSize:                        257,
		IssuanceWeights: IssuanceWeights{
			BaseTotalIssuedPerMinute:       tz.BigUint{0xc4, 0xbb, 0xc4, 0x28},
			BakingRewardFixedPortionWeight: 5120,
			BakingRewardBonusWeight:        5120,
			AttestingRewardWeight:          10240,
			LiquidityBakingSubsidyWeight:   1280,
			SeedNonceRevelationTipWeight:   1,
			VDFRevelationTipWeight:         1,
		},
		CostPerByte:                       tz.BigUint{0xfa, 0x01},
		HardStorageLimitPerOperation:      tz.BigInt{0xa0, 0xa9, 0x07},
		QuorumMin:                         2000,
		QuorumMax:                         7000,
		MinProposalQuorum:                 500,
		LiquidityBakingToggleEmaThreshold: 1000000000,
		MaxOperationsTimeToLive:           240,
		MinimalBlockDelay:                 8,
		DelayIncrementPerRound:            3,
		ConsensusCommitteeSize:            7000,
		ConsensusThreshold:                4667,
		MinimalParticipationRatio:         core.Rat{2, 3},
		LimitOfDelegationOverBaking:       9,
		PercentageOfFrozenDepositsSlashedPerDoubleBaking:      5,
		PercentageOfFrozenDepositsSlashedPerDoubleAttestation: 50,
		TestnetDictator:              tz.Some[tz.PublicKeyHash](&tz.Ed25519PublicKeyHash{0x83, 0xd7, 0x2f, 0x98, 0xdc, 0x41, 0xba, 0xa8, 0xb7, 0x11, 0x36, 0xf0, 0x5e, 0x2b, 0xc1, 0xdf, 0xd5, 0x24, 0x86, 0x2f}),
		CacheScriptSize:              100000000,
		CacheStakeDistributionCycles: 8,
		CacheSamplerStateCycles:      8,
		DALParametric: DALParametric{
			FeatureEnable:        false,
			NumberOfSlots:        256,
			AttestationLag:       4,
			AttestationThreshold: 50,
			BlocksPerEpoch:       1,
			RedundancyFactor:     16,
			PageSize:             4096,
			SlotSize:             1048576,
			NumberOfShards:       2048,
		},
		SmartRollupArithPVMEnable:                 false,
		SmartRollupOriginationSize:                6314,
		SmartRollupChallengeWindowInBlocks:        40,
		SmartRollupStakeAmount:                    tz.BigUint{0x80, 0xc8, 0xaf, 0xa0, 0x25},
		SmartRollupCommitmentPeriodInBlocks:       20,
		SmartRollupMaxLookaheadInBlocks:           30000,
		SmartRollupMaxActiveOutboxLevels:          20160,
		SmartRollupMaxOutboxMessagesPerLevel:      100,
		SmartRollupNumberOfSectionsInDissection:   32,
		SmartRollupTimeoutPeriodInBlocks:          500,
		SmartRollupMaxNumberOfCementedCommitments: 5,
		SmartRollupMaxNumberOfParallelGames:       32,
		SmartRollupRevealActivationLevel: SmartRollupRevealActivationLevel{
			RawData:       0,
			Metadata:      0,
			DALPage:       2147483646,
			DALParameters: 2147483646,
		},
		SmartRollupPrivateEnable:           true,
		SmartRollupRiscvPVMEnable:          false,
		ZkRollupEnable:                     false,
		ZkRollupOriginationSize:            4000,
		ZkRollupMinPendingToProcess:        10,
		ZkRollupMaxTicketPayloadSize:       2048,
		GlobalLimitOfStakingOverBaking:     5,
		EdgeOfStakingOverDelegation:        2,
		AdaptiveIssuanceLaunchEmaThreshold: 100000000,
		AdaptiveRewardsParams: AdaptiveRewardsParams{
			IssuanceRatioMin: core.BigRat{
				tz.BigInt{0x01},
				tz.BigInt{0x90, 0x1f},
			},
			IssuanceRatioMax: core.BigRat{
				tz.BigInt{0x01},
				tz.BigInt{0x14},
			},
			MaxBonus: 50000000000000,
			GrowthRate: core.BigRat{
				tz.BigInt{0x01},
				tz.BigInt{0xa4, 0x01},
			},
			CenterDz: core.BigRat{
				tz.BigInt{0x01},
				tz.BigInt{0x02},
			},
			RadiusDz: core.BigRat{
				tz.BigInt{0x01},
				tz.BigInt{0x32},
			},
		},
		AdaptiveIssuanceActivationVoteEnable: false,
		AutostakingEnable:                    true,
	}

	var out Constants
	_, err := encoding.Decode(src, &out, encoding.Dynamic())
	if !assert.NoError(t, err) {
		if err, ok := err.(*encoding.Error); ok {
			fmt.Println(err.Path)
		}
	} else {
		require.Equal(t, &expect, &out)
	}
}
