//go:build ignore

package main

import (
	"log"
	"os"
	"text/template"
)

const (
	ModeVar int = iota
	ModeConstruct
	ModeConstructPtr
	ModeAllocate
)

type typeDef struct {
	Func         string
	RequestType  string
	Path         string
	Method       string
	ResponseType string
	Mode         int
}

var types = []*typeDef{
	{
		RequestType:  "BlockRequest",
		Method:       "GET",
		Path:         "/chains/{{.Chain}}/blocks/{{.Block}}/header{{with .Metadata}}?metadata={{.}}{{end}}",
		Func:         "BlockHeader",
		ResponseType: "BlockHeaderInfo",
		Mode:         ModeAllocate,
	},
	{
		RequestType:  "BlockRequest",
		Method:       "GET",
		Path:         "/chains/{{.Chain}}/blocks/{{.Block}}{{with .Metadata}}?metadata={{.}}{{end}}",
		Func:         "Block",
		ResponseType: "BlockInfo",
		Mode:         ModeAllocate,
	},
	{
		RequestType:  "DelegateRequest",
		Method:       "GET",
		Path:         "/chains/{{.Chain}}/blocks/{{.Block}}/context/delegates/{{.PKH}}",
		Func:         "Delegate",
		ResponseType: "DelegateInfo",
		Mode:         ModeConstruct,
	},
	{
		RequestType:  "ContractRequest",
		Method:       "GET",
		Path:         "/chains/{{.Chain}}/blocks/{{.Block}}/context/contracts/{{.ID}}/balance",
		Func:         "ContractBalance",
		ResponseType: "BigUint",
		Mode:         ModeVar,
	},
	{
		RequestType:  "ContractRequest",
		Method:       "GET",
		Path:         "/chains/{{.Chain}}/blocks/{{.Block}}/context/contracts/{{.ID}}/balance_and_frozen_bonds",
		Func:         "ContractBalanceAndFrozenBonds",
		ResponseType: "BigUint",
		Mode:         ModeVar,
	},
}

const tplSrc = `package client

import (
	"context"
	"strings"
	"text/template"
)

// Code generated by generate.go DO NOT EDIT.
{{range .}}
var path_{{.Func}} = template.Must(template.New("path").Parse("{{.Path}}"))

func (client *Client) {{.Func}}(ctx context.Context, r *{{.RequestType}}) ({{if eq .Mode 2 3}}*{{end}}{{.ResponseType}}, error) {
	tmp := *r
	if tmp.Chain == "" {
		tmp.Chain = client.Chain
	}

	var path strings.Builder
	if err := path_{{.Func}}.Execute(&path, &tmp); err != nil {
		return nil, err
	}

	{{if eq .Mode 0 -}}
	var response {{.ResponseType}}
	{{else if eq .Mode 1 2 -}}
	response, err := new{{.ResponseType}}(r.Protocol)
	if err != nil {
		return nil, err
	}
	{{else -}}
	response := new({{.ResponseType}})
	{{end}}
	if err := client.request("{{.Method}}", path.String(), {{if eq .Mode 0}}&{{end}}response, ctx); err != nil {
		return nil, err
	}
	return response, nil
}
{{end}}
`

var tpl = template.Must(template.New("formatter").Parse(tplSrc))

const outName = "request_gen.go"

func main() {
	fd, err := os.Create(outName)
	if err != nil {
		log.Fatal(err)
	}
	defer fd.Close()
	if err = tpl.Execute(fd, types); err != nil {
		log.Fatal(err)
	}
}
